# Demo Configuration (November 17, 2024)

**Last Updated**: 2024-11-13  
**Target**: Small-scale school project demo with interactive detailed mode

---

## Overview

This document explains the configuration settings for the November 17th demo, ensuring the system operates in **interactive-detailed mode** with **LLM-generated commit messages** using the PR Narrator Agent.

---

## ‚úÖ Configuration Changes Applied

### 1. Default Execution Mode: Interactive-Detailed

**File**: `src/repoai/api/models.py`  
**Line**: 60

```python
mode: str = Field(
    default="interactive-detailed",  # Changed from "autonomous"
    description="Execution mode: 'autonomous', 'interactive', or 'interactive-detailed'",
)
```

**Impact**:
- All refactoring requests now default to `interactive-detailed` mode
- Users see **two confirmation points**:
  1. **Plan Confirmation** (after planning stage)
  2. **Push Confirmation** (before git operations)
- Users can approve, modify, or cancel at each checkpoint

**User Experience**:
```
User submits refactoring request
     ‚Üì
[Planning Stage]
     ‚Üì
‚è∏Ô∏è  PAUSE: Review and confirm plan
     ‚Üì (user approves)
[Transformation + Validation]
     ‚Üì
[PR Narration]
     ‚Üì
‚è∏Ô∏è  PAUSE: Review changes and approve push
     ‚Üì (user approves)
[Git Operations: Branch + Commit + Push]
     ‚Üì
‚úÖ Complete
```

---

### 2. PR Narrator Agent Integration

**File**: `src/repoai/orchestrator/orchestrator_agent.py`  
**Method**: `_run_narration_stage()` (lines 772-812)

**Before** (placeholder implementation):
```python
# TODO: Implement PR Narrator Agent
# For now, create a basic PR description
pr_description = PRDescription(
    title=f"feat: {self.state.job_spec.intent}",
    summary=f"Implemented refactoring based on user request: {self.state.user_prompt}",
    ...
)
```

**After** (full LLM-powered agent):
```python
# Import PR Narrator Agent
from repoai.agents.pr_narrator_agent import run_pr_narrator_agent
from repoai.dependencies import PRNarratorDependencies

# Prepare dependencies
pr_deps = PRNarratorDependencies(
    code_changes=self.state.code_changes,
    validation_result=self.state.validation_result,
    plan_id=self.state.plan.plan_id if self.state.plan else "unknown",
)

# Run PR Narrator Agent to generate comprehensive PR description
pr_description, pr_metadata = await run_pr_narrator_agent(
    code_changes=self.state.code_changes,
    validation_result=self.state.validation_result,
    dependencies=pr_deps,
    adapter=self.adapter,
)
```

**Impact**:
- PR descriptions are now **LLM-generated** with professional quality
- Commit messages automatically use **PR Narrator output**
- Comprehensive documentation of:
  - What was changed and why
  - Breaking changes (if any)
  - Migration guides
  - Testing performed

**Example PR Description** (generated by PR Narrator):
```markdown
# feat: Add JWT authentication to user service

## Summary
This PR implements JWT-based authentication for the User Service using 
Spring Security 6.0. The changes provide stateless authentication with 
role-based access control (RBAC).

## Changes by File
- `src/main/java/com/example/config/SecurityConfig.java` (CREATED)
  - Configured JWT authentication filter chain
  - Added CORS and CSRF configuration
  
- `src/main/java/com/example/security/JwtTokenProvider.java` (CREATED)
  - JWT token generation and validation
  - Expiration handling (24 hours)

## Breaking Changes
‚ö†Ô∏è **Authentication Required**: All `/api/*` endpoints now require valid JWT token

## Migration Guide
1. Update frontend to include `Authorization: Bearer <token>` header
2. Obtain token via `/api/auth/login` endpoint
3. Refresh tokens before expiration

## Testing
- ‚úÖ Unit tests: 95% coverage
- ‚úÖ Integration tests: Authentication flow validated
- ‚úÖ Manual testing: Postman collection provided
```

---

### 3. Commit Message Flow

**File**: `src/repoai/orchestrator/orchestrator_agent.py`  
**Method**: `_run_git_operations_stage()` (lines 1127-1130)

```python
# Use PR description summary or fallback to user prompt
commit_message = (
    message_override
    or (self.state.pr_description.summary if self.state.pr_description else None)
    or self.state.user_prompt
    or "RepoAI automated refactoring"
)
```

**Priority**:
1. `message_override` (if user provides custom message during push confirmation)
2. **`pr_description.summary`** ‚Üê **PR Narrator Agent output** ‚úÖ
3. `user_prompt` (original request)
4. `"RepoAI automated refactoring"` (fallback)

**Impact**:
- Commit messages are **professional and descriptive**
- Generated by LLM based on actual code changes
- Example: `"feat: Add JWT authentication to user service using Spring Security"`

---

### 4. Branch Naming Strategy

**File**: `src/repoai/orchestrator/orchestrator_agent.py`  
**Lines**: 1119

```python
# Create branch name
branch_name = branch_override or f"repoai/{self.state.session_id}"
```

**Pattern**: `repoai/<session_id>`

**Examples**:
- `repoai/sess_a1b2c3d4`
- `repoai/sess_e5f6g7h8`

**Benefits**:
- Unique per refactoring session
- Easy to identify automated refactorings
- Avoids branch name conflicts
- Traceable to specific sessions

**Override**: Users can provide custom branch name during push confirmation

---

## üéØ Demo Flow (Interactive-Detailed Mode)

### Step 1: User Submits Request
```http
POST /api/v1/refactor/start
{
  "user_id": "demo_user_001",
  "user_prompt": "Add caching to product service using Redis",
  "github_credentials": {...},
  "mode": "interactive-detailed"  // Default, can be omitted
}
```

### Step 2: System Generates Plan
- Intake Agent parses request
- Planner Agent creates 5-step plan
- **System pauses for plan confirmation**

### Step 3: User Reviews Plan via SSE
```json
{
  "type": "progress",
  "status": "paused",
  "stage": "planning",
  "message": "‚è∏Ô∏è  Plan ready for review",
  "requires_confirmation": true,
  "confirmation_type": "plan",
  "data": {
    "plan_summary": "# Refactoring Plan\n\n**Steps:** 5...",
    "risk_level": 3,
    "breaking_changes": false
  }
}
```

### Step 4: User Confirms Plan
```http
POST /api/v1/refactor/{session_id}/confirm
{
  "action": "approve"
}
```

**Alternative**: User can modify or cancel
```http
POST /api/v1/refactor/{session_id}/confirm
{
  "action": "modify",
  "modifications": "Also add cache eviction on product updates"
}
```

### Step 5: Transformation + Validation
- Transformer Agent creates/modifies files
- **Files streamed one-by-one to frontend** via SSE
- Validator Agent checks compilation and tests

```json
{
  "type": "file_modified",
  "event_type": "file_modified",
  "file_path": "src/main/java/com/example/service/ProductService.java",
  "data": {
    "original_content": "public class ProductService {...}",
    "modified_content": "@Cacheable\npublic class ProductService {...}",
    "diff": "@@ -10,3 +10,5 @@...",
    "imports": ["org.springframework.cache.annotation.Cacheable"],
    "methods": ["getProductById", "getAllProducts"]
  }
}
```

### Step 6: PR Narration
- **PR Narrator Agent generates description** (LLM-powered)
- Summary, changes by file, breaking changes, testing notes
- This summary will be used as commit message

### Step 7: Push Confirmation
- **System pauses before git operations**
- User sees PR description preview

```json
{
  "type": "progress",
  "status": "paused",
  "stage": "git_operations",
  "message": "‚è∏Ô∏è  Ready to push changes",
  "requires_confirmation": true,
  "confirmation_type": "push",
  "data": {
    "pr_description": {
      "title": "feat: Add Redis caching to product service",
      "summary": "Implemented caching for product queries...",
      "changes_by_file": [...],
      "breaking_changes": []
    },
    "branch": "repoai/sess_abc123",
    "files_changed": 3
  }
}
```

### Step 8: User Approves Push
```http
POST /api/v1/refactor/{session_id}/confirm
{
  "action": "push"
}
```

**Optional overrides**:
```http
POST /api/v1/refactor/{session_id}/confirm
{
  "action": "push",
  "branch_override": "feature/redis-caching",
  "message_override": "Add Redis caching with Spring Boot"
}
```

### Step 9: Git Operations Execute
```bash
# Branch creation
git checkout -b repoai/sess_abc123

# Commit with PR Narrator summary
git commit -m "feat: Add Redis caching to product service"
# Author: RepoAI Bot <repoai@example.com>

# Push to remote
git push origin repoai/sess_abc123
```

### Step 10: Completion
```json
{
  "type": "progress",
  "status": "completed",
  "stage": "complete",
  "message": "üéâ Pipeline completed successfully! (42.3s)",
  "data": {
    "branch": "repoai/sess_abc123",
    "files_changed": 3,
    "duration_ms": 42300,
    "pr_url": "https://github.com/user/repo/compare/repoai/sess_abc123"
  }
}
```

---

## üìä What Users See in Demo

### Frontend Display Components

1. **Plan Review Card**
   - Risk level indicator (colored badge)
   - Step-by-step breakdown
   - Estimated files affected
   - Approve/Modify/Cancel buttons

2. **File Changes Feed** (real-time streaming)
   - Side-by-side diff viewer (`react-diff-viewer`)
   - Syntax highlighting
   - File tree navigation
   - Expandable/collapsible changes

3. **PR Description Preview**
   - Markdown-rendered PR description
   - Breaking changes highlighted
   - Testing summary
   - Editable branch name and commit message

4. **Confirmation Modals**
   - Plan confirmation with modification text area
   - Push confirmation with branch/message overrides
   - Natural language support ("looks good", "cancel this", etc.)

---

## üõ†Ô∏è Technical Details

### Session Isolation
- Each session has unique `session_id`
- In-memory queues: `confirmation_queues[session_id]`
- **No race conditions** (asyncio.Queue per session)
- Supports concurrent users

### LLM Intent Interpretation
```python
async def _interpret_user_intent(user_response: str) -> ConfirmationDecision:
    """
    LLM interprets natural language confirmation responses.
    
    Examples:
    - "looks good" ‚Üí action="approve"
    - "cancel this" ‚Üí action="cancel"
    - "add unit tests" ‚Üí action="modify", modifications="add unit tests"
    """
    ...
```

### File Content Streaming
- **One file at a time** (not batched)
- Sent immediately after transformation
- Full contents + unified diff
- Frontend renders with `react-diff-viewer`

### Git Operations
```python
# Lifecycle: Clone ‚Üí Modify ‚Üí Commit ‚Üí Push ‚Üí Cleanup
1. Clone to /tmp/repoai_XXXXXX/
2. Make code changes
3. Create branch: repoai/{session_id}
4. Commit with PR Narrator summary
5. Push to remote
6. Clean up temp directory
```

---

## ‚öôÔ∏è Configuration Summary

| Setting | Value | File | Line |
|---------|-------|------|------|
| Default Mode | `interactive-detailed` | `api/models.py` | 60 |
| PR Narrator | Enabled (LLM-powered) | `orchestrator_agent.py` | 772-812 |
| Branch Pattern | `repoai/{session_id}` | `orchestrator_agent.py` | 1119 |
| Commit Message | PR Narrator summary | `orchestrator_agent.py` | 1127-1130 |
| Commit Author | RepoAI Bot | `orchestrator_agent.py` | 1136-1137 |
| File Streaming | One-by-one SSE | `orchestrator_agent.py` | 440-500 |
| Confirmation Points | 2 (plan + push) | `orchestrator_agent.py` | 180-217 |

---

## üß™ Testing for Demo

### Pre-Demo Checklist

1. **Start API Server**
   ```bash
   cd RepoAI_AI
   uv run uvicorn repoai.api.main:app --reload --port 8000
   ```

2. **Test Interactive-Detailed Mode**
   ```bash
   # Should default to interactive-detailed (no need to specify mode)
   curl -X POST http://localhost:8000/api/v1/refactor/start \
     -H "Content-Type: application/json" \
     -d '{
       "user_id": "demo_user",
       "user_prompt": "Add logging to main service",
       "github_credentials": {...}
     }'
   ```

3. **Verify SSE Streaming**
   ```bash
   curl -N http://localhost:8000/api/v1/refactor/{session_id}/stream
   # Should see real-time progress events
   ```

4. **Test Confirmation Endpoints**
   ```bash
   # Plan confirmation
   curl -X POST http://localhost:8000/api/v1/refactor/{session_id}/confirm \
     -H "Content-Type: application/json" \
     -d '{"action": "approve"}'
   
   # Natural language (LLM interprets)
   curl -X POST http://localhost:8000/api/v1/refactor/{session_id}/confirm \
     -H "Content-Type: application/json" \
     -d '{"user_response": "looks good, proceed"}'
   ```

5. **Verify PR Narrator Output**
   - Check logs for "Running PR Narrator Agent..."
   - Verify commit message uses `pr_description.summary`
   - Inspect GitHub for professional PR description quality

---

## üìÖ Timeline Integration

**November 13-17** (Before Demo):
- ‚úÖ **Day 1 (Nov 13)**: Configuration applied (this document)
- üî≤ **Day 2 (Nov 14)**: Java backend integration
  - Add mode field to backend models
  - Create confirmation endpoints (plan + push)
  - Set up SSE listener for file streaming
- üî≤ **Day 3 (Nov 15)**: Frontend implementation
  - File diff viewer with `react-diff-viewer`
  - Plan confirmation modal
  - Push confirmation modal with overrides
- üî≤ **Day 4 (Nov 16)**: E2E testing
  - Test full flow with real GitHub repo
  - Verify PR Narrator quality
  - Test natural language confirmations
- üî≤ **Day 5 (Nov 17)**: **DEMO DAY** üéâ

**After Demo (Nov 18+)**:
- RAG integration (deferred)
- Performance optimization
- Production deployment

---

## üö® Important Notes for Demo

1. **Always show interactive-detailed mode**:
   - Mode is now default, don't override
   - Highlight the two confirmation points
   - Show natural language confirmation ("looks good")

2. **Emphasize PR Narrator quality**:
   - Show before/after commit messages
   - Highlight LLM-generated descriptions
   - Compare to manual commit messages

3. **Demonstrate file streaming**:
   - Show real-time diff viewer updates
   - One file at a time visibility
   - Side-by-side comparison

4. **Branch naming**:
   - Explain `repoai/{session_id}` pattern
   - Show how to override if needed
   - Emphasize uniqueness and traceability

5. **Concurrency support**:
   - Mention session isolation
   - Safe for multiple concurrent users
   - No race conditions

---

## üîç Troubleshooting

### Issue: Mode not defaulting to interactive-detailed
**Solution**: Check `api/models.py` line 60 is `default="interactive-detailed"`

### Issue: PR Narrator not being called
**Solution**: Verify `orchestrator_agent.py` imports `run_pr_narrator_agent` (line 772)

### Issue: Commit message is user prompt instead of PR summary
**Solution**: Check PR Narrator stage completed successfully (logs should show "PR Narration completed")

### Issue: No confirmation prompts appearing
**Solution**: Verify mode is `interactive-detailed` in request (should be default)

---

## üìö Related Documentation

- [File Content Streaming](file_content_streaming.md)
- [Frontend Diff Rendering](frontend_diff_rendering.md)
- [Integration Setup](../INTEGRATION_SETUP.md)
- [Streaming Implementation](streaming_implementation.md)

---

**Demo Configuration Complete!** ‚úÖ

All settings verified and documented for November 17th demo.
